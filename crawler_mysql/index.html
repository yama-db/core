<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAMAP/Yamareco 山名地図</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 100vh; width: 100%; }
        body { margin: 0; padding: 0; }
        /* ラベル（Tooltip）のスタイル調整 */
        .custom-label {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #666;
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 12px;
            white-space: nowrap;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([36.0, 138.0], 7);

    // 地理院タイル（標準地図）
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
    }).addTo(map);

    // 1. カスタムアイコンの定義
    const mountainIcon = L.icon({
        iconUrl: '902030.png',
        iconSize: [24, 24],      // 画像のサイズ（ピクセル）
        iconAnchor: [12, 12],    // アイコンの中心を座標に合わせる
        popupAnchor: [0, -12],   // ポップアップが出る位置
        tooltipAnchor: [15, 0]   // ラベル（Tooltip）が出る位置
    });

    // 2. PHPからGeoJSONデータを取得
    const params = new URLSearchParams(window.location.search);
    const dbType = params.get('db') || 'yamap';

    fetch(`pois.php?db=${dbType}`)
        .then(response => response.json())
        .then(data => {
            L.geoJSON(data, {
                // ポイントをアイコンに変換
                pointToLayer: function (feature, latlng) {
                    const marker = L.marker(latlng, { icon: mountainIcon });
                    
                    // ラベル（name）を常時表示する設定
                    if (feature.properties && feature.properties.name) {
                        marker.bindTooltip(feature.properties.name, {
                            permanent: true,       // 常に表示
                            direction: 'right',    // アイコンの右側に表示
                            className: 'custom-label', // カスタムCSSクラス
                            offset: [5, 0]         // 位置の微調整
                        });
                    }
                    return marker;
                },
                // クリック時の詳細ポップアップ
                onEachFeature: function (feature, layer) {
                    const props = feature.properties;
                    const elevation = props.elevation ? `${props.elevation} m` : '不明';
                    const raw_remote_id = props.raw_remote_id;
                    layer.bindPopup(`<strong>${props.name}</strong><br>標高: ${elevation}<br>ID: ${raw_remote_id}`);
                }
            }).addTo(map);
        })
        .catch(error => console.error('Error:', error));
</script>
</body>
</html>